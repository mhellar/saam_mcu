var express = require('express');
var wmataApi = require('./server');
const request = require('request');


const WMATA_API_KEY = process.env.WMATA_API_KEY;

var api = new wmataApi(WMATA_API_KEY);
var app = express();

app.get('/buspositions', function(req, res){
	var routeId = req.query.routeid;
	console.log('Got this routeID: ' + routeId);
    var options = {
        routeId: routeId
    };

	api.getBusPositions(options)
		.then(data => {
			res.json(data);
		})
		.catch(err => {
			console.log("ERROR: " + err);
			res.status(404).json(err);
		});
});

app.get('/predictions', function(req, res){
    // var stopId = 1001195;
    var stopId = 'meepmoop';
    api.getBusPredictions(stopId)
        .then(data => {
            res.json(data);
        })
        .catch(err => {
            console.log("ERROR: " + err);
            res.status(404).json(err);
        });
});

app.get('/trainpositions', function(req, res){
    api.getTrainPositions()
        .then(data => {
            res.json(data);
        })
        .catch(err => {
            console.log("ERROR: " + err);
            res.status(404).json(err);
        });
});

app.get('/trainpredictions', function(req, res){
    var stationCode = 'B10';
    api.getTrainPredictions(stationCode)
        .then(data => {
            res.json(data);
        })
        .catch(err =>{
            console.log("ERROR: " + err);
            res.status(404).json(err);
        });
});


app.get('/test', function(req, res){
	console.log('Inside test route');
	request.get({
		url: 'https://api.wmata.com/Bus.svc/json/jBusPositions?routeId=D2',
		headers: {
			'api_key': WMATA_API_KEY
		}
	}, function(err, resp, body){
		res.json(resp);
	});
});

app.listen(3000, function(){
	console.log("API listening on port 3000");
});
